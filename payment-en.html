<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Me - Hair/Makeup Tips Creation</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <img src="better-me-logo.png" alt="Better Me" class="main-logo">
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="payment-container">
            <div class="payment-header">
                <h1><i class="fas fa-palette"></i> Hair/Makeup Tips Creation</h1>
            </div>

            <div class="payment-content">
                <!-- Service Description -->
                <div class="service-description">
                    <h2><i class="fas fa-star"></i> Service Details</h2>
                    <div class="service-features">
                        <div class="feature-item">
                            <i class="fas fa-cut"></i>
                            <div>
                                <h3>Personalized Hair Style Recommendations</h3>
                                <p>Get the perfect hairstyle recommendations based on your face shape and hairline analysis</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-paint-brush"></i>
                            <div>
                                <h3>Customized Makeup Guide</h3>
                                <p>Receive makeup style and product recommendations tailored to your skin tone and facial features</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-mobile-alt"></i>
                            <div>
                                <h3>Detailed Styling Guide</h3>
                                <p>Step-by-step makeup tutorials and hairstyling tips provided</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="pricing-section">
                    <h2><i class="fas fa-tags"></i> Pricing</h2>
                    <div class="price-card">
                        <div class="price-header">
                            <h3>Hair/Makeup Tips Package</h3>
                            <div class="price-amount">
                                <span class="currency">₩</span>
                                <span class="amount">29,000</span>
                            </div>
                        </div>
                        <ul class="price-features">
                            <li><i class="fas fa-check"></i> 3 personalized hairstyle recommendations</li>
                            <li><i class="fas fa-check"></i> 3 makeup style guides</li>
                            <li><i class="fas fa-check"></i> Product recommendations and purchase guide</li>
                            <li><i class="fas fa-check"></i> Step-by-step styling methods</li>
                            <li><i class="fas fa-check"></i> Unlimited access for 30 days</li>
                        </ul>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="payment-methods">
                    <h2><i class="fas fa-credit-card"></i> Payment Methods</h2>
                    <div class="payment-options">
                        <div class="payment-option">
                            <input type="radio" id="card" name="payment" value="card" checked>
                            <label for="card">
                                <i class="fas fa-credit-card"></i>
                                <span>Credit Card</span>
                            </label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" id="paypal" name="payment" value="paypal">
                            <label for="paypal">
                                <i class="fab fa-paypal"></i>
                                <span>PayPal</span>
                            </label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" id="apple-pay" name="payment" value="apple-pay">
                            <label for="apple-pay">
                                <i class="fab fa-apple-pay"></i>
                                <span>Apple Pay</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="payment-actions">
                    <button class="btn btn-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Go Back
                    </button>
                    <button class="btn btn-primary btn-large" onclick="processPayment()">
                        <i class="fas fa-credit-card"></i> Pay ₩29,000
                    </button>
                </div>

                <!-- Terms -->
                <div class="payment-terms">
                    <p><small>
                        You can use the service immediately after payment completion.<br>
                        Refund Policy: 100% refund available before service use
                    </small></p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; Better Me Personal information is deleted immediately after use.</p>
    </footer>

    <script>
        function goBack() {
            window.history.back();
        }

        function processPayment() {
            const selectedPayment = document.querySelector('input[name="payment"]:checked').value;
            
            if (selectedPayment === 'card') {
                processCardPayment();
            } else if (selectedPayment === 'paypal') {
                processPayPalPayment();
            } else if (selectedPayment === 'apple-pay') {
                processApplePayPayment();
            }
        }

        async function processCardPayment() {
            try {
                showLoadingModal('Processing credit card payment...');
                
                // Stripe 결제 의도 생성
                const response = await fetch(`${getApiBaseUrl()}/api/payment/stripe/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 29000,
                        currency: 'usd'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    hideLoadingModal();
                    // 실제 구현에서는 Stripe Elements를 사용하여 카드 정보 입력 폼을 표시
                    // 여기서는 시뮬레이션으로 성공 처리
                    showPaymentSuccess('Credit card payment completed! (Test Mode)');
                } else {
                    throw new Error(data.error || 'Failed to create payment intent.');
                }
            } catch (error) {
                hideLoadingModal();
                console.error('Card payment error:', error);
                alert('An error occurred during card payment: ' + error.message);
            }
        }

        async function processPayPalPayment() {
            try {
                showLoadingModal('Creating PayPal order...');
                
                // PayPal 주문 생성
                const response = await fetch(`${getApiBaseUrl()}/api/payment/paypal/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 29000,
                        currency: 'USD'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.approvalUrl) {
                    hideLoadingModal();
                    // 테스트 모드에서는 시뮬레이션으로 성공 처리
                    showPaymentSuccess('PayPal payment completed! (Test Mode)');
                } else {
                    throw new Error(data.error || 'Failed to create PayPal order.');
                }
            } catch (error) {
                hideLoadingModal();
                console.error('PayPal payment error:', error);
                alert('An error occurred during PayPal payment: ' + error.message);
            }
        }

        function processApplePayPayment() {
            // Check if Apple Pay is available
            if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
                showLoadingModal('Processing Apple Pay...');
                
                // Simulate Apple Pay processing
                setTimeout(() => {
                    hideLoadingModal();
                    showPaymentSuccess('Apple Pay payment completed!');
                }, 2000);
            } else {
                alert('Apple Pay is not available on this device. Please use another payment method.');
            }
        }

        function showLoadingModal(message) {
            alert('Loading: ' + message);
        }

        function hideLoadingModal() {
            // Hide loading modal
        }

        function showPaymentSuccess(message) {
            alert(message + '\n\nStarting hair/makeup tips analysis!');
            // Start makeup tips analysis after payment completion
            startMakeupTipsAnalysis();
        }

        // Makeup tips analysis function
        function startMakeupTipsAnalysis() {
            try {
                // Navigate to makeup tips analysis page
                window.location.href = 'makeup-tips-analysis-en.html';
            } catch (error) {
                console.error('Makeup tips analysis page navigation error:', error);
                alert('An error occurred while navigating to makeup tips analysis page: ' + error.message);
            }
        }
        
        // Convert DataURL to Blob function
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        // Get API server URL function
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const apiPort = '3000'; // API server always runs on port 3000
            if (hostname === 'localhost' || hostname.startsWith('192.168.') || hostname.startsWith('10.') || hostname.startsWith('172.')) {
                return `http://${hostname}:${apiPort}`;
            }
            return `https://${hostname}`;
        }

        // Update styles when payment method is selected
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.classList.remove('selected');
                });
                this.closest('.payment-option').classList.add('selected');
            });
        });

        // Apply initial selected item style
        document.querySelector('input[name="payment"]:checked').closest('.payment-option').classList.add('selected');
    </script>
</body>
</html>
