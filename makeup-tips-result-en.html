<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Me - Makeup Tips Results</title>
    <link rel="stylesheet" href="styles.css?v=18">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BVF6W1YC2F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} 
      gtag('js', new Date());
      gtag('config', 'G-BVF6W1YC2F');
    </script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo-container">
            <img src="better-me-logo.png" alt="Better Me" class="main-logo">
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <!-- ë‹¨ê³„ë³„ ì§„í–‰ í‘œì‹œ -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Photo Usage Agreement</div>
            </div>
            <div class="step active" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Photo Upload</div>
            </div>
            <div class="step active" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Makeup Tips Analysis</div>
            </div>
            <div class="step active" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">View Results</div>
            </div>
        </div>

        <!-- 4ë‹¨ê³„: ë©”ì´í¬ì—… íŒ ë¶„ì„ ê²°ê³¼ -->
        <div class="step-panel active" id="step-4">
            <h2>Tip Creation Results</h2>
            
            <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë“¤ í‘œì‹œ -->
            <div class="uploaded-image-section">
                <div class="analysis-images-grid">
                    <div class="analysis-image-item">
                        <h4><i class="fas fa-user"></i> Front Photo</h4>
                        <img id="step4-uploaded-image-front" src="" alt="Front Photo" class="analysis-image">
                    </div>
                    <div class="analysis-image-item">
                        <h4><i class="fas fa-user-friends"></i> 45Â° Side Photo</h4>
                        <img id="step4-uploaded-image-45" src="" alt="45Â° Side Photo" class="analysis-image">
                    </div>
                    <div class="analysis-image-item">
                        <h4><i class="fas fa-user-secret"></i> 90Â° Side Photo</h4>
                        <img id="step4-uploaded-image-90" src="" alt="90Â° Side Photo" class="analysis-image">
                    </div>
                </div>
            </div>
            
            <div class="feedback-container">
                <div class="feedback-details">
                    <div class="complete-analysis">
                        <div class="analysis-content" id="complete-analysis-content">
                            <p>Waiting for tip creation results...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="step-buttons">
                <button class="btn btn-success" onclick="saveStep4AsImage()" id="save-step4">
                    <i class="fas fa-image"></i> Save as Image
                </button>
                <button class="btn btn-primary" onclick="goToPayment()" id="tip-creation-btn">
                    <i class="fas fa-palette"></i> Create Hair/Makeup Tips
                </button>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <p>&copy; 2024 Better Me. All rights reserved.</p>
                <p>Incheon Metropolitan City, Gyeyang-gu, Seoun Industrial Complex-ro 1-gil 19 (Seoun-dong) DSE 320</p>
            </div>
        </div>
    </footer>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let analysisResults = null;
        let uploadedImages = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Makeup tips results page loaded');
            loadMakeupTipsResults();
            loadUploadedImages();
        });

        // ë©”ì´í¬ì—… íŒ ê²°ê³¼ ë¡œë“œ
        function loadMakeupTipsResults() {
            try {
                const savedResults = sessionStorage.getItem('beautyAI_makeupTipsResults');
                console.log('Makeup tips results from session storage:', savedResults);
                
                if (savedResults) {
                    analysisResults = JSON.parse(savedResults);
                    console.log('Parsed makeup tips results:', analysisResults);
                    displayFullAIResponse(analysisResults);
                    console.log('Makeup tips results loaded');
                } else {
                    console.error('No makeup tips results found');
                    const analysisContent = document.getElementById('complete-analysis-content');
                    if (analysisContent) {
                        analysisContent.innerHTML = '<div class="error-message">No tip creation results found.</div>';
                    }
                }
            } catch (error) {
                console.error('Makeup tips results loading error:', error);
            }
        }

        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¡œë“œ ë° í‘œì‹œ
        function loadUploadedImages() {
            try {
                const savedImages = sessionStorage.getItem('beautyAI_uploadedImages');
                if (savedImages) {
                    uploadedImages = JSON.parse(savedImages);
                    displayStep4Images();
                    console.log('Uploaded images loaded');
                } else {
                    console.error('No uploaded images found');
                }
            } catch (error) {
                console.error('Image loading error:', error);
            }
        }

        // 4ë‹¨ê³„ ì´ë¯¸ì§€ í‘œì‹œ
        function displayStep4Images() {
            if (!uploadedImages) return;

            // Front image display
            if (uploadedImages.front && uploadedImages.front.dataUrl) {
                const frontPreview = document.getElementById('step4-uploaded-image-front');
                if (frontPreview) {
                    frontPreview.src = uploadedImages.front.dataUrl;
                }
            }

            // 45Â° side image display
            if (uploadedImages['45'] && uploadedImages['45'].dataUrl) {
                const side45Preview = document.getElementById('step4-uploaded-image-45');
                if (side45Preview) {
                    side45Preview.src = uploadedImages['45'].dataUrl;
                }
            }

            // 90Â° side image display
            if (uploadedImages['90'] && uploadedImages['90'].dataUrl) {
                const side90Preview = document.getElementById('step4-uploaded-image-90');
                if (side90Preview) {
                    side90Preview.src = uploadedImages['90'].dataUrl;
                }
            }
        }

        // AI ì‘ë‹µ í‘œì‹œ (4ë‹¨ê³„ì™€ ë™ì¼í•œ êµ¬ì¡°)
        function displayFullAIResponse(analysisData) {
            try {
                const analysisContent = document.getElementById('complete-analysis-content');
                if (!analysisContent) {
                    console.error('Analysis result display container not found');
                    return;
                }

                if (!analysisData || !analysisData.raw_analysis) {
                    console.error('No analysis data:', analysisData);
                    analysisContent.innerHTML = '<p>Analysis results not found.</p>';
                    return;
                }

                // AI ë¶„ì„ ê²°ê³¼ë¥¼ ì–¼êµ´ë¶„ì„ê³¼ ë™ì¼í•œ formatAnalysisResult í•¨ìˆ˜ë¡œ êµ¬ì¡°í™”
                const analysisText = analysisData.raw_analysis;
                console.log('Original analysis text:', analysisText);
                const formattedContent = formatAnalysisResult(analysisText);
                console.log('Formatted HTML content:', formattedContent);
                analysisContent.innerHTML = formattedContent;
                
                console.log('AI response display completed');
            } catch (error) {
                console.error('Error displaying AI response:', error);
                const analysisContent = document.getElementById('complete-analysis-content');
                if (analysisContent) {
                    analysisContent.innerHTML = '<p>An error occurred while displaying results.</p>';
                }
            }
        }

        // ë¶„ì„ ê²°ê³¼ë¥¼ Figma ë””ìì¸ì— ë§ê²Œ êµ¬ì¡°í™”ëœ HTMLë¡œ ë³€í™˜ (ì–¼êµ´ë¶„ì„ê³¼ ë™ì¼)
        function formatAnalysisResult(text) {
            if (!text) {
                console.log('formatAnalysisResult: empty text');
                return '';
            }
            
            console.log('formatAnalysisResult start, text length:', text.length);
            
            // í…ìŠ¤íŠ¸ë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë¶„í• 
            const lines = text.split('\n').filter(line => line.trim());
            console.log('Number of lines:', lines.length);
            
            let html = '';
            let currentSection = '';
            let sectionContent = '';
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                
                // ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ì œëª© (1. 2. 3. ë“±) - Figma ë””ìì¸ì˜ ë©”ì¸ ì œëª©
                if (/^\d+\./.test(trimmedLine)) {
                    // ì´ì „ ì„¹ì…˜ ë‹«ê¸°
                    if (currentSection) {
                        html += `<div class="section">
                            <div class="main-title">${currentSection}</div>
                            <div class="content-text">${sectionContent}</div>
                            <div class="divider"></div>
                        </div>`;
                        sectionContent = '';
                    }
                    
                    // ì œëª©ì„ Figma ë””ìì¸ì— ë§ê²Œ êµ¬ì„±
                    const sectionNumber = trimmedLine.match(/^(\d+)\./)[1];
                    const iconMap = {
                        '1': 'ğŸ‘¤', '2': 'ğŸ“', '3': 'âœ¨', '4': 'ğŸ‘ï¸', '5': 'ğŸ‘ƒ', '6': 'ğŸ‘„', '7': 'ğŸ†', '8': 'â­'
                    };
                    const icon = iconMap[sectionNumber] || 'ğŸ“‹';
                    const titleText = trimmedLine.replace(/^\d+\.\s*/, '');
                    currentSection = `${icon} ${sectionNumber}. ${titleText}`;
                }
                // ì½œë¡ ìœ¼ë¡œ ëë‚˜ëŠ” ì†Œì œëª© (ì •ë©´ê¸°ì¤€:, 45ë„/90ë„ ê¸°ì¤€: ë“±)
                else if (trimmedLine.includes(':') && !trimmedLine.includes('**')) {
                    sectionContent += `<div class="subtitle">${trimmedLine}</div>`;
                }
                // ê°•ì¡° í…ìŠ¤íŠ¸ (**í…ìŠ¤íŠ¸**) - ë©”ì´í¬ì—…íŒì—ì„œëŠ” ë³„í‘œ ì œê±°
                else if (trimmedLine.includes('**')) {
                    const formattedLine = trimmedLine.replace(/\*\*(.*?)\*\*/g, '$1');
                    sectionContent += `<div class="content-line">${formattedLine}</div>`;
                }
                // ë¹ˆ ì¤„ì´ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸
                else if (trimmedLine.length > 0) {
                    sectionContent += `<div class="content-line">${trimmedLine}</div>`;
                }
                
                // ë§ˆì§€ë§‰ ì¤„ì¸ ê²½ìš° ì„¹ì…˜ ë‹«ê¸°
                if (index === lines.length - 1) {
                    if (currentSection) {
                        html += `<div class="section">
                            <div class="main-title">${currentSection}</div>
                            <div class="content-text">${sectionContent}</div>
                        </div>`;
                    }
                }
            });
            
            // ì „ì²´ë¥¼ Figma ë””ìì¸ ì»¨í…Œì´ë„ˆë¡œ ê°ì‹¸ê¸°
            const result = `<div class="analysis-result-container">${html}</div>`;
            console.log('formatAnalysisResult completed, generated HTML length:', result.length);
            console.log('Final HTML:', result);
            return result;
        }

        // 4ë‹¨ê³„ ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜
        async function saveStep4AsImage() {
            try {
                console.log('=== 4ë‹¨ê³„ ì´ë¯¸ì§€ ì €ì¥ ì‹œì‘ ===');
                
                // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ìœ¼ë¡œ íŒŒì¼ëª… ìƒì„±
                const now = new Date();
                const dateString = now.toISOString().slice(0, 19).replace(/[:-]/g, '');
                
                // 4ë‹¨ê³„ ìº¡ì²˜
                console.log('4ë‹¨ê³„ ìº¡ì²˜ ì‹œì‘...');
                const step4Element = document.getElementById('step-4');
                console.log('4ë‹¨ê³„ ìš”ì†Œ ì°¾ê¸° ê²°ê³¼:', step4Element);
                
                if (step4Element) {
                    // 4ë‹¨ê³„ ì´ë¯¸ì§€ë“¤ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const step4Images = step4Element.querySelectorAll('img[id*="step4-uploaded-image"]');
                    console.log('4ë‹¨ê³„ì—ì„œ ì°¾ì€ ì´ë¯¸ì§€ ê°œìˆ˜:', step4Images.length);
                    
                    // ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ í™•ì¸ ë° ê°•ì œ ë¡œë”©
                    let allImagesLoaded = true;
                    for (let img of step4Images) {
                        console.log(`ì´ë¯¸ì§€ í™•ì¸:`, img.id, 'src:', img.src, 'complete:', img.complete);
                        
                        if (img.src && img.src !== '') {
                            // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê°•ì œë¡œ ë¡œë“œ
                            if (!img.complete) {
                                console.log(`${img.id} ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸° ì¤‘...`);
                                await new Promise((resolve, reject) => {
                                    const timeout = setTimeout(() => {
                                        console.warn(`${img.id} ì´ë¯¸ì§€ ë¡œë”© íƒ€ì„ì•„ì›ƒ`);
                                        resolve();
                                    }, 2000);
                                    
                                    img.onload = () => {
                                        clearTimeout(timeout);
                                        console.log(`${img.id} ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ`);
                                        resolve();
                                    };
                                    
                                    img.onerror = () => {
                                        clearTimeout(timeout);
                                        console.error(`${img.id} ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨`);
                                        allImagesLoaded = false;
                                        resolve();
                                    };
                                });
                            }
                        } else {
                            console.warn(`${img.id} ì´ë¯¸ì§€ srcê°€ ë¹„ì–´ìˆìŒ`);
                            allImagesLoaded = false;
                        }
                    }
                    
                    console.log('ëª¨ë“  ì´ë¯¸ì§€ ë¡œë”© ìƒíƒœ:', allImagesLoaded);
                    
                    // 4ë‹¨ê³„ë¥¼ í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ìƒíƒœë¡œ ìº¡ì²˜
                    const canvas4 = await html2canvas(step4Element, {
                        scale: 2, // ê³ í•´ìƒë„ë¡œ ì„¤ì •
                        useCORS: true,
                        allowTaint: true,
                        logging: true, // ë””ë²„ê¹…ì„ ìœ„í•´ ë¡œê¹… í™œì„±í™”
                        removeContainer: false,
                        imageTimeout: 5000, // ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸° ì‹œê°„ ì¦ê°€
                        foreignObjectRendering: false,
                        backgroundColor: '#ffffff' // ë°°ê²½ìƒ‰ ì„¤ì •
                    });
                    
                    console.log('4ë‹¨ê³„ ìº”ë²„ìŠ¤ í¬ê¸°:', canvas4.width, 'x', canvas4.height);
                    
                    // 4ë‹¨ê³„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                    const fileName4 = `makeup-tips-result-${dateString}.png`;
                    downloadImage(canvas4, fileName4);
                    console.log('4ë‹¨ê³„ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ:', fileName4);
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    alert('Makeup tips result image has been saved successfully!');
                    
                } else {
                    console.error('4ë‹¨ê³„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    alert('Step 4 element not found.');
                }
                
            } catch (error) {
                console.error('4ë‹¨ê³„ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('An error occurred while saving the image: ' + error.message);
            }
        }

        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadImage(canvas, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
            console.log('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
        }

        // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToPayment() {
            window.location.href = 'payment-en.html';
        }
    </script>
</body>
</html>