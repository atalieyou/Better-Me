<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Me - Makeup Tips Analysis</title>
    <link rel="stylesheet" href="styles.css?v=18">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BVF6W1YC2F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} 
      gtag('js', new Date());
      gtag('config', 'G-BVF6W1YC2F');
    </script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo-container">
            <img src="better-me-logo.png" alt="Better Me" class="main-logo">
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <!-- ë‹¨ê³„ë³„ ì§„í–‰ í‘œì‹œ -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Photo Usage Agreement</div>
            </div>
            <div class="step active" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Photo Upload</div>
            </div>
            <div class="step active" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Tip Creation</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">View Results</div>
            </div>
        </div>

        <!-- 3ë‹¨ê³„: ë©”ì´í¬ì—… íŒ ë¶„ì„ -->
        <div class="step-panel active" id="step-3">
            <h2>AI is analyzing makeup and hair tips...</h2>
            <div class="loading-page">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h3>Precise makeup/hair tips creation is in progress for 1-2 minutes</h3>
                    
                    <!-- ì§„í–‰ë¥  ë°” ì¶”ê°€ -->
                    <div class="progress-container">
                        <!-- ì§„í–‰ë¥  ë°” -->
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysis-progress-fill"></div>
                        </div>
                        
                        <!-- ê°„ë‹¨í•œ ì§„í–‰ í…ìŠ¤íŠ¸ -->
                            <div class="progress-text" id="analysis-progress-text">AI is creating makeup/hair tips...<span class="loading-dots" id="loading-dots"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <p>&copy; 2024 Better Me. All rights reserved.</p>
                <p>Incheon Metropolitan City, Gyeyang-gu, Seoun Industrial Complex-ro 1-gil 19 (Seoun-dong) DSE 320</p>
            </div>
        </div>
    </footer>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let analysisResults = null;
        let uploadedImages = null;
        let currentStep = 3;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Makeup tips analysis page loaded');
            
            // íƒ€ì´í•‘ íš¨ê³¼ ì‹œì‘
            startTypingEffect();
            
            initializeMakeupTipsAnalysis();
        });

        // íƒ€ì´í•‘ íš¨ê³¼ í•¨ìˆ˜ (í”„ë¡œê·¸ë ˆìŠ¤ í…ìŠ¤íŠ¸ìš©, ë°˜ë³µ)
        function startTypingEffect() {
            const progressTextElement = document.getElementById('analysis-progress-text');
            if (!progressTextElement) return;

            const fullText = 'AI is creating makeup/hair tips...';
            let currentIndex = 0;
            let isTyping = true;

            function typeChar() {
                if (!isTyping) return;
                
                if (currentIndex < fullText.length) {
                    // ë¡œë”© ì  ì œê±°í•˜ê³  íƒ€ì´í•‘
                    const loadingDots = progressTextElement.querySelector('.loading-dots');
                    progressTextElement.innerHTML = fullText.substring(0, currentIndex + 1);
                    if (loadingDots) {
                        progressTextElement.appendChild(loadingDots);
                    }
                    currentIndex++;
                    setTimeout(typeChar, 100); // 100msë§ˆë‹¤ í•œ ê¸€ìì”©
                } else {
                    // íƒ€ì´í•‘ ì™„ë£Œ í›„ ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œì‘
                    setTimeout(() => {
                        currentIndex = 0;
                        setTimeout(typeChar, 1000); // 1ì´ˆ í›„ ë‹¤ì‹œ ì‹œì‘
                    }, 2000); // 2ì´ˆ ëŒ€ê¸°
                }
            }

            // íƒ€ì´í•‘ íš¨ê³¼ ì‹œì‘
            setTimeout(typeChar, 500); // 0.5ì´ˆ í›„ ì‹œì‘

            // ë¶„ì„ ì™„ë£Œ ì‹œ íƒ€ì´í•‘ ì¤‘ë‹¨
            window.stopTypingEffect = function() {
                isTyping = false;
            };
        }

        // ë©”ì´í¬ì—… íŒ ë¶„ì„ ì´ˆê¸°í™”
        function initializeMakeupTipsAnalysis() {
            try {
                // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¡œë“œ
                loadUploadedImages();
                
                // ë¶„ì„ ì‹œì‘
                startMakeupTipsAnalysis();
                
                console.log('Makeup tips analysis initialization completed');
            } catch (error) {
                console.error('Makeup tips analysis initialization error:', error);
                showError('Unable to start makeup tips analysis.');
            }
        }

        // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¡œë“œ
        function loadUploadedImages() {
            try {
                const savedImages = sessionStorage.getItem('beautyAI_uploadedImages');
                if (savedImages) {
                    uploadedImages = JSON.parse(savedImages);
                    console.log('Uploaded images loaded');
                } else {
                    console.error('No uploaded images found');
                    showError('No uploaded images found.');
                }
            } catch (error) {
                console.error('Image loading error:', error);
                showError('Error occurred while loading images.');
            }
        }

        // ë©”ì´í¬ì—… íŒ ë¶„ì„ ì‹œì‘
        async function startMakeupTipsAnalysis() {
            try {
                console.log('ğŸ” Starting makeup tips analysis');
                
                // ì§„í–‰ë¥  ì´ˆê¸°í™”
                updateProgress(0, 'Starting makeup tips analysis...');
                
                // 1ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì–¼êµ´ë¶„ì„ ê²°ê³¼ í™•ì¸
                console.log('1ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì–¼êµ´ë¶„ì„ ê²°ê³¼ í™•ì¸...');
                const clientFaceAnalysis = sessionStorage.getItem('beautyAI_analysisResults');
                
                if (clientFaceAnalysis) {
                    console.log('âœ… í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì–¼êµ´ë¶„ì„ ê²°ê³¼ ë°œê²¬');
                    // í´ë¼ì´ì–¸íŠ¸ì— ì–¼êµ´ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë©”ì´í¬ì—… íŒ ë¶„ì„ ì§„í–‰
                    await proceedWithMakeupAnalysis(clientFaceAnalysis);
                    return;
                } else {
                    console.log('âŒ í´ë¼ì´ì–¸íŠ¸ì— ì–¼êµ´ë¶„ì„ ê²°ê³¼ ì—†ìŒ, ì„œë²„ì—ì„œ í™•ì¸ ì‹œë„');
                }
                
                // ì´ë¯¸ì§€ ë°ì´í„° ê²€ì¦
                if (!uploadedImages || (!uploadedImages.front && !uploadedImages['45'] && !uploadedImages['90'])) {
                    throw new Error('No uploaded images found.');
                }
                
                // FormData ìƒì„±
                const formData = new FormData();
                
                // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
                if (uploadedImages.front && uploadedImages.front.dataUrl) {
                    const frontBlob = dataURLtoBlob(uploadedImages.front.dataUrl);
                    formData.append('front', frontBlob, 'front.jpg');
                    updateProgress(20, 'Processing front photo...');
                }
                if (uploadedImages['45'] && uploadedImages['45'].dataUrl) {
                    const side45Blob = dataURLtoBlob(uploadedImages['45'].dataUrl);
                    formData.append('side45', side45Blob, 'side45.jpg');
                    updateProgress(40, 'Processing 45Â° side photo...');
                }
                if (uploadedImages['90'] && uploadedImages['90'].dataUrl) {
                    const side90Blob = dataURLtoBlob(uploadedImages['90'].dataUrl);
                    formData.append('side90', side90Blob, 'side90.jpg');
                    updateProgress(60, 'Processing 90Â° side photo...');
                }
                
                // ì–¸ì–´ ì •ë³´ ì¶”ê°€
                formData.append('language', 'en');
                
                // ì„¸ì…˜ ID ì¶”ê°€
                const sessionId = `makeup_tips_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                formData.append('sessionId', sessionId);
                
                updateProgress(80, 'AI is analyzing makeup tips...');
                
                // API í˜¸ì¶œ
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/analyze-makeup-tips`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'Makeup tips analysis completed!');
                    
                    // ë¶„ì„ ê²°ê³¼ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    const makeupTipsResult = {
                        raw_analysis: result.analysis.analysis || result.analysis
                    };
                    console.log('Makeup tips analysis result saved:', makeupTipsResult);
                    sessionStorage.setItem('beautyAI_makeupTipsResults', JSON.stringify(makeupTipsResult));
                    
                    // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = 'makeup-tips-result-en.html';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Makeup tips analysis failed.');
                }
                
            } catch (error) {
                console.error('Makeup tips analysis error:', error);
                showError('An error occurred during makeup tips analysis: ' + error.message);
            }
        }

        // í´ë¼ì´ì–¸íŠ¸ ì–¼êµ´ë¶„ì„ ê²°ê³¼ë¡œ ë©”ì´í¬ì—… íŒ ë¶„ì„ ì§„í–‰
        async function proceedWithMakeupAnalysis(faceAnalysisResult) {
            try {
                updateProgress(20, 'Face analysis results confirmed...');
                
                // FormData ìƒì„±
                const formData = new FormData();
                
                // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
                if (uploadedImages.front && uploadedImages.front.dataUrl) {
                    const frontBlob = dataURLtoBlob(uploadedImages.front.dataUrl);
                    formData.append('front', frontBlob, 'front.jpg');
                    updateProgress(40, 'Processing front photo...');
                }
                if (uploadedImages['45'] && uploadedImages['45'].dataUrl) {
                    const side45Blob = dataURLtoBlob(uploadedImages['45'].dataUrl);
                    formData.append('side45', side45Blob, 'side45.jpg');
                    updateProgress(60, 'Processing 45-degree side photo...');
                }
                if (uploadedImages['90'] && uploadedImages['90'].dataUrl) {
                    const side90Blob = dataURLtoBlob(uploadedImages['90'].dataUrl);
                    formData.append('side90', side90Blob, 'side90.jpg');
                    updateProgress(80, 'Processing 90-degree side photo...');
                }
                
                // ì–¸ì–´ ì„¤ì • ì¶”ê°€
                formData.append('language', 'en');
                
                // ì„¸ì…˜ ID ì¶”ê°€
                const sessionId = `makeup_tips_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                formData.append('sessionId', sessionId);
                
                // ì–¼êµ´ë¶„ì„ ê²°ê³¼ ID ì¶”ê°€ (ì„œë²„ì—ì„œ ì €ì¥ëœ ê²°ê³¼ ID)
                let faceAnalysisResultId = sessionStorage.getItem('beautyAI_resultId');
                
                // beautyAI_resultIdê°€ ì—†ìœ¼ë©´ ëŒ€ì²´ ë°©ë²• ì‹œë„
                if (!faceAnalysisResultId) {
                    console.log('beautyAI_resultId not found, trying alternative methods...');
                    
                    // 1. analysisResultsê°€ sessionStorageì— ìˆëŠ”ì§€ í™•ì¸
                    const storedAnalysisResults = sessionStorage.getItem('beautyAI_analysisResults');
                    if (storedAnalysisResults) {
                        try {
                            const analysisData = JSON.parse(storedAnalysisResults);
                            if (analysisData && analysisData.raw_analysis) {
                                console.log('Found analysis results in sessionStorage, using directly');
                                formData.append('faceAnalysisResult', JSON.stringify(analysisData.raw_analysis));
                            }
                        } catch (e) {
                            console.error('Failed to parse stored analysis results:', e);
                        }
                    }
                    
                    // 2. ì—¬ì „íˆ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ìµœê·¼ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!storedAnalysisResults) {
                        console.log('No analysis results found, redirecting to face analysis...');
                        alert('Face analysis results are required. Redirecting to face analysis page.');
                        window.location.href = 'face-analysis-en.html';
                        return;
                    }
                } else {
                    formData.append('faceAnalysisResultId', faceAnalysisResultId);
                    console.log('Face analysis result ID passed:', faceAnalysisResultId);
                }
                
                    updateProgress(90, 'AI is creating makeup/hair tips...');
                
                // API í˜¸ì¶œ
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/analyze-makeup-tips`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'Makeup tips analysis completed!');
                    
                    // ë¶„ì„ ê²°ê³¼ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    const makeupTipsResult = {
                        raw_analysis: result.analysis.analysis || result.analysis
                    };
                    console.log('Makeup tips analysis result saved:', makeupTipsResult);
                    sessionStorage.setItem('beautyAI_makeupTipsResults', JSON.stringify(makeupTipsResult));
                    
                    // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = 'makeup-tips-result-en.html';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Makeup tips analysis failed.');
                }
                
            } catch (error) {
                console.error('Makeup tips analysis error:', error);
                showError('An error occurred during makeup tips analysis: ' + error.message);
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage, message) {
            const progressFill = document.getElementById('analysis-progress-fill');
            const progressText = document.getElementById('analysis-progress-text');
            
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
            
            // í”„ë¡œê·¸ë ˆìŠ¤ í…ìŠ¤íŠ¸ëŠ” íƒ€ì´í•‘ íš¨ê³¼ë¡œë§Œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            console.log(`Progress: ${percentage}% - ${message}`);
        }

        // DataURLì„ Blobìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        // API ì„œë²„ URL ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const apiPort = '3000'; // API ì„œë²„ëŠ” í•­ìƒ 3000 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘
            if (hostname === 'localhost' || hostname.startsWith('192.168.') || hostname.startsWith('10.') || hostname.startsWith('172.')) {
                return `http://${hostname}:${apiPort}`;
            }
            return `https://${hostname}`;
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            updateProgress(0, 'An error occurred.');
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            }
            alert(message);
        }
    </script>
</body>
</html>
